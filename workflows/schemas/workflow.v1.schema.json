{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "BCCE Workflow v1",
  "type": "object",
  "required": ["version", "workflow", "steps"],
  "properties": {
    "version": { "const": 1 },
    "workflow": { 
      "type": "string", 
      "minLength": 1,
      "description": "Human-readable workflow name"
    },
    "model": { 
      "type": "string",
      "description": "Bedrock model ID, Inference Profile ARN, or environment variable substitution",
      "minLength": 1
    },
    "guardrails": { 
      "type": "array", 
      "items": { "type": "string" },
      "description": "List of Guardrails template names to apply"
    },
    "env": {
      "type": "object",
      "properties": {
        "max_runtime_seconds": { "type": "integer", "minimum": 1, "maximum": 3600 },
        "artifacts_dir": { "type": "string" },
        "seed": { "type": "integer" }
      },
      "additionalProperties": true,
      "description": "Environment variables and runtime configuration"
    },
    "steps": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["id", "type"],
        "properties": {
          "id": { 
            "type": "string", 
            "pattern": "^[a-z][a-z0-9_]*$",
            "description": "Unique step identifier (lowercase, alphanumeric + underscore)" 
          },
          "type": { 
            "enum": ["prompt", "agent", "cmd", "apply_diff", "custom"],
            "description": "Step execution type"
          },
          "prompt_file": {
            "type": "string",
            "description": "Path to prompt markdown file (for prompt steps)"
          },
          "command": {
            "type": "string", 
            "description": "Shell command to execute (for cmd steps)"
          },
          "on_error": {
            "enum": ["fail", "continue", "retry"],
            "default": "fail",
            "description": "Error handling strategy"
          },
          "approve": {
            "type": "boolean",
            "default": false,
            "description": "Auto-approve changes (dangerous in CI)"
          },
          "available_tools": {
            "type": "array",
            "items": {
              "enum": ["ReadFile", "Search", "Diff", "Apply", "Cmd", "Bash"]
            },
            "description": "Tools available to this step"
          },
          "policy": {
            "type": "object",
            "properties": {
              "timeout_seconds": { "type": "integer", "minimum": 1, "maximum": 1800 },
              "max_files": { "type": "integer", "minimum": 1, "maximum": 1000 },
              "max_edits": { "type": "integer", "minimum": 1, "maximum": 1000 },
              "allowed_paths": { 
                "type": "array", 
                "items": { "type": "string" },
                "description": "Glob patterns for allowed file paths"
              },
              "cmd_allowlist": {
                "type": "array",
                "items": { "type": "string" },
                "description": "Allowed command prefixes"
              }
            },
            "description": "Security and resource constraints for agent steps"
          },
          "inputs": {
            "type": "object",
            "properties": {
              "paths": { 
                "type": "array", 
                "items": { "type": "string" },
                "description": "Input file/directory paths"
              },
              "file_size_limit_kb": { 
                "type": "integer", 
                "minimum": 1,
                "maximum": 10240,
                "default": 256,
                "description": "Maximum file size to read in KB"
              }
            },
            "additionalProperties": true,
            "description": "Step-specific input parameters"
          }
        },
        "additionalProperties": false
      }
    }
  },
  "additionalProperties": false
}